# HTML 调用 gRPC 服务 - 完整运行说明

## 架构说明

```
浏览器 (test.html)
    ↓ HTTP POST (JSON)
HTTP Gateway (gateway.go:8080)
    ↓ gRPC
gRPC Server (server/main.go:50051)
    ↓ 返回结果
HTTP Gateway
    ↓ JSON
浏览器显示结果
```

## 运行步骤

### 1. 启动 gRPC 服务器

```bash
# 在项目根目录下运行
go run server/main.go
```

你应该看到：
```
Server listening on :50051
```

### 2. 启动 HTTP Gateway

打开新的终端窗口：

```bash
# 在项目根目录下运行
go run web/gateway.go
```

你应该看到：
```
HTTP Gateway listening on :8080
访问 http://localhost:8080/test.html 来测试
```

### 3. 在浏览器中测试

打开浏览器访问：
```
http://localhost:8080/test.html
```

在页面上：
1. 输入第一个数字（例如：10）
2. 输入第二个数字（例如：20）
3. 点击"计算"按钮
4. 查看结果（应该显示 30）

## 技术实现细节

### HTTP Gateway (web/gateway.go)
- 监听 8080 端口
- 提供 `/api/add` 接口接收 JSON 请求
- 内部连接到 gRPC 服务器 (localhost:50051)
- 将 HTTP 请求转换为 gRPC 调用
- 支持 CORS，允许跨域访问
- 提供静态文件服务

### HTML 页面 (web/test.html)
- 使用 Fetch API 发送 POST 请求
- JSON 格式传递参数：`{a: number, b: number}`
- 接收 JSON 响应：`{result: number}`
- 优雅的 UI 设计和错误处理
- 支持键盘快捷键（回车提交）

### 数据流

1. **HTML → Gateway**
   ```json
   POST http://localhost:8080/api/add
   Content-Type: application/json
   
   {
     "a": 10,
     "b": 20
   }
   ```

2. **Gateway → gRPC Server**
   ```protobuf
   message AddRequest {
     int32 a = 1;
     int32 b = 2;
   }
   ```

3. **gRPC Server → Gateway**
   ```protobuf
   message AddResponse {
     int32 result = 1;
   }
   ```

4. **Gateway → HTML**
   ```json
   {
     "result": 30
   }
   ```

## 故障排除

### 问题：页面显示连接错误

**解决方案：**
1. 确保 gRPC 服务器正在运行 (端口 50051)
2. 确保 HTTP Gateway 正在运行 (端口 8080)
3. 检查防火墙设置

### 问题：端口已被占用

**解决方案：**
- 修改 `server/main.go` 中的 `:50051` 为其他端口
- 修改 `web/gateway.go` 中的 `:8080` 为其他端口
- 相应地更新 gateway.go 中连接 gRPC 的地址

### 问题：Cannot find package

**解决方案：**
```bash
go mod tidy
go mod download
```

## 扩展功能建议

1. **添加更多数学运算**
   - 减法 (Subtract)
   - 乘法 (Multiply)
   - 除法 (Divide)

2. **使用 gRPC-Web**
   - 如果想要更标准的实现，可以考虑使用 gRPC-Web + Envoy

3. **添加认证**
   - JWT Token
   - API Key

4. **添加日志**
   - 记录所有请求
   - 性能监控

## 相关文件

- `proto/calculator.proto` - gRPC 服务定义
- `server/main.go` - gRPC 服务器实现
- `web/gateway.go` - HTTP 网关服务器
- `web/test.html` - 前端页面
- `gen/proto/` - 生成的 protobuf 代码

## 注意事项

1. 生产环境建议使用 TLS/SSL
2. 应该添加适当的错误处理和日志
3. 考虑添加请求验证和限流
4. HTTP Gateway 可以添加缓存机制

